# Obsidian Log 要件定義書 v3.0

## 1. システム概要

### 1.1 目的

Obsidian Log は、開発者本人の

・タスク進捗
・学習ログ
・技術ナレッジ

を可視化し、ポートフォリオとして公開するための
「行動 × 知識」可視化アプリケーションである。

タスクは状態管理として扱い、
ナレッジは履歴資産として扱う。

---

### 1.2 デザインコンセプト

Obsidian の名前から連想される、黒くてスマートな画面を想定する。

- ダークテーマを基調としたUI
- 落ち着いたトーンで情報を整理して表示
- 知的で洗練された印象

---

## 2. 全体アーキテクチャ

[ ナレッジ系 ]

GitHub Repository（Markdown）
↓
Vercel Build時取得
↓
SSG または ISR
↓
公開表示

[ タスク系 ]

Supabase (PostgreSQL)
↓
Supabase API / Realtime
↓
フロントエンドでリアルタイム反映

### 2.1 技術スタック


| 項目           | 採用技術                      |
| ---------------- | ------------------------------- |
| ホスティング   | Vercel                        |
| フロントエンド | TanStack Start                |
| 言語           | TypeScript                    |
| データベース   | Supabase (PostgreSQL)         |
| 認証           | Supabase Auth（GitHub OAuth） |
| コンテンツ管理 | GitHub (Markdown)             |

#### 開発時

- ナレッジ取得: ローカルの `content/` ディレクトリにモックデータを用意し、GitHub API の代わりに参照する
  - `content/articles/` … 記事の .md ファイル
  - `content/scraps/` … スクラップの .json ファイル
- 本番ビルド時のみ GitHub API で取得

#### ディレクトリ設計（ハイブリッド feature-based）

ルート定義は `src/routes/` に維持しつつ、ロジック・コンポーネントを feature 単位で分離する。

- **routes/**: TanStack Router のファイルベースルーティング。URL とページの対応のみ定義
- **features/**: 機能ごとに API・型・コンポーネントを集約（articles, scraps, tasks, admin）
- **shared/**: 複数 feature で使うライブラリ（Supabase クライアント、slug 検証等）・共通コンポーネント

詳細は [開発ガイド](./開発ガイド.md) を参照。

---

## 3. データ設計

### 3.1 ナレッジ（GitHub）

GitHub API により、リポジトリ直下からデータを取得する。

- **URL**: 管理画面のダッシュボードから設定可能（`site_config` テーブルで管理）
- **デフォルト**: 空文字 `""`。アプリ使用時に管理画面から URL を登録する設計
- **公開範囲**: public リポジトリを想定（認証不要で取得可能）

#### 取得対象ディレクトリ


| ディレクトリ | ファイル形式 | 内容                         |
| -------------- | -------------- | ------------------------------ |
| articles     | slug名.md    | Markdown形式で記事内容を取得 |
| scraps       | slug名.json  | JSON形式でscrapの内容を取得  |

#### 記事（articles）

- ファイル形式: `slug名.md`
- Markdown形式
- Frontmatter でメタデータを管理（title, createdAt, topics, visibility, type 等）
- タグは `topics` から取得（Zenn 形式）。`topics: ["a","b"]` または `topics:\n  - a\n  - b` に対応

#### Scrap（scraps）データ構造

```json
{
  "title": "string",
  "closed": "boolean",
  "archived": "boolean",
  "created_at": "string",
  "comments": [
    {
      "author": "string",
      "created_at": "string",
      "body_markdown": "string",
      "body_updated_at": "string",
      "children": [
        {
          "author": "string",
          "created_at": "string",
          "body_markdown": "string",
          "body_updated_at": "string",
          "children": []
        }
      ]
    }
  ]
}
```

- `comments` はネスト可能（`children` で再帰構造）
- `body_updated_at` は任意

**タグ（末尾ブラケット記法）**:
- タイトル末尾に `[tag1] [tag2]` 形式でタグを記述可能
- 末尾に連続する `[xxx]` のみをタグとしてパースし、表示用タイトルからは除去する
- タグで一覧フィルタ可能（`/scraps?tag=xxx`）

**表示制御（スクラップ）**:
- `closed` と `archived` は Zenn エクスポート形式の互換性のためデータには含まれるが、UI では表示しない

#### Scrap 同期フロー

作者はスクラップをよく使うが、Zenn CLI 管理は難しいと考える。そのため以下の運用とする。

- **記述**: Zenn 上でスクラップを記述する
- **同期**: Zenn から手動エクスポートしたデータを GitHub に同期する
- **反映**: GitHub への同期完了後、Obsidian Log に反映される（ビルド時取得）

Zenn CLI による管理は行わない。

#### 表示制御

- public のみサイトに表示
- private はビルド時除外

---

### 3.2 タスク（Supabase）

#### tasks テーブル

- id (uuid, primary key)
- title (text)
- description (text)
- status (enum: todo | doing | done)
- visibility (enum: public | private)
- started_at (timestamp)
- completed_at (timestamp)
- created_at (timestamp)
- updated_at (timestamp)

#### admins テーブル

管理者判定用。Supabase Auth の user_id を登録する。

- user_id (uuid, primary key) … auth.uid() と突き合わせる
- created_at (timestamp)

#### site_config テーブル

サイト設定を key-value で管理。管理画面のダッシュボードから編集可能。

- key (text, primary key) … 設定キー（例: `github_repo_url`）
- value (text) … 設定値
- updated_at (timestamp)

主なキー:

| key | 説明 | 例 |
|-----|------|-----|
| github_repo_url | ナレッジ取得元の GitHub リポジトリ URL | 使用時に管理画面から登録 |

将来の拡張でキーを追加可能。

**注意**: `site_config` には機密情報（API トークン、パスワード等）を保存しない。機密情報は環境変数や別テーブル（RLS で制限）で管理する。

---

## 4. ページ構成・URLルーティング

### 4.1 サイトのコンセプト

トップページはポートフォリオサイトの延長として、ブログ＋タスク管理状態の可視化を組み合わせた構成とする。

- ブログ的な記事・スクラップの一覧・詳細
- タスクの進捗（消化率、期間別集計など）の可視化

### 4.2 URL ルーティング

| パス | 説明 | 認証 |
|------|------|------|
| `/` | トップページ（ブログ＋タスクサマリ） | 不要 |
| `/articles` | 記事一覧 | 不要 |
| `/articles/$slug` | 記事詳細 | 不要 |
| `/scraps` | スクラップ一覧 | 不要 |
| `/scraps/$slug` | スクラップ詳細 | 不要 |
| `/tasks` | タスク一覧・消化率・期間別集計 | 不要 |
| `/admin` | 管理画面トップ（ダッシュボード） | 要（GitHub OAuth + 管理者） |
| `/admin/tasks` | タスク管理（Todoアプリ） | 要（管理者のみ） |
| `/admin/settings` | サイト設定（GitHub URL 等） | 要（管理者のみ） |

※ 管理ルート（`/admin/*`）はサーバー側で `auth.uid() IN (SELECT user_id FROM admins)` を確認し、非管理者は 403 またはリダイレクトする。

### 4.3 トップページの表示内容

- 最新記事・スクラップのプレビュー（ブログ風）
- タスク消化率のサマリ（done / total）
- 各セクションへのナビゲーション

---

## 5. 機能要件

### 5.1 公開機能（一般ユーザー）

#### 5.1.1 ナレッジ表示

- public記事一覧表示
- タグフィルタ
- タイトル・本文検索
- 詳細ページ表示
- Markdownレンダリング

**slug の検証（パストラバーサル対策）**:
- `/articles/$slug`, `/scraps/$slug` の slug は英数字・ハイフン・アンダースコアのみ許可
- `..`, `/` を含む場合は拒否

**Markdown レンダリング（XSS 対策）**:
- サニタイズ済みの Markdown レンダラーを使用
- 必要に応じて DOMPurify 等で HTML をサニタイズ

更新方式:
SSG または ISR

---

#### 5.1.2 タスク表示

- visibility = public のみ取得
- ステータス別表示
- 消化率表示（done / total）
- 期間別集計（週・月）
- リアルタイム更新

---

### 5.2 管理機能（Admin）

#### 5.2.1 サイト設定（ダッシュボード）

管理画面のダッシュボードから以下を設定可能。

- **GitHub リポジトリ URL**: ナレッジ取得元の URL（`site_config` テーブルで管理）
- 変更後、次回ビルド（または ISR 再検証）時に反映

**GitHub URL の検証（SSRF 対策）**:
- 形式: `https://github.com/{owner}/{repo}` のみ許可
- ホストを `github.com` に限定
- 上記以外は保存時・取得時に拒否する

#### 5.2.2 ナレッジ管理

**記事（articles）**

- GitHub にて Markdown 編集
- push で自動反映（Webhook想定）

**スクラップ（scraps）**

- Zenn 上で記述
- Zenn から手動エクスポート → GitHub に同期 → Obsidian Log に反映
- Zenn CLI は使用しない

Web UI での CRUD は実装しない。

---

#### 5.2.3 タスク管理

管理画面からはTodoアプリとして機能する。管理者は日常のタスク管理をこの画面で行う。

**認証方式**

- Supabase Auth の **GitHub OAuth** でログイン
- パスワード管理不要、コンテンツ管理（GitHub）とアカウントを統一

**管理者判定**

- `admins` テーブルに登録された `user_id`（= auth.uid()）のみ管理者として扱う
- RLS ポリシーで `auth.uid() IN (SELECT user_id FROM admins)` をチェック
- 初回登録・管理者の追加・削除は運用手順書を参照

**ログイン UI 仕様**

| 項目 | 仕様 |
|------|------|
| ログインボタン配置 | ヘッダーナビの「管理」リンク付近、または管理ルート（`/admin`）内に「GitHub でログイン」ボタンを表示 |
| 未ログイン時の `/admin/*` アクセス | ログインページ（またはログインフォーム）を表示。ログイン後は元のパスへリダイレクト |
| ログイン方式 | Supabase Auth の `signInWithOAuth({ provider: 'github' })` を使用 |
| ログアウト | 管理画面内にログアウトボタンを配置。`signOut()` でログアウト後、トップまたは `/admin` へ遷移 |
| ログイン状態の表示 | 管理画面ヘッダーにログイン中のユーザー表示（GitHub ユーザー名等）。未ログイン時はログインボタンのみ |
| 管理者以外のログイン | GitHub でログインしたが admins に未登録の場合、403 または「管理者権限がありません」メッセージを表示し、ログアウトを促す |

**権限**

- Admin のみ insert/update/delete 可能
- 一般ユーザーは select のみ可能

**Row Level Security (RLS) 設定**

*tasks テーブル*

- select（未ログイン）: `visibility = 'public'` の行のみ
- select（管理者）: `auth.uid() IN (SELECT user_id FROM admins)` の場合は全行（public + private）
- insert/update/delete: `auth.uid() IN (SELECT user_id FROM admins)`

*admins テーブル*

- select: `auth.uid() = user_id` のみ（自分が admins に含まれる場合のみ自分の行を読める）
- insert/update/delete: Service Role または Dashboard 経由で実施（初回登録・運用は運用手順書を参照）

*site_config テーブル*

- select: 全員可（ビルド時・公開ページで URL 取得に使用。GitHub URL は非機密）
- insert/update/delete: `auth.uid() IN (SELECT user_id FROM admins)`

---

## 6. 非機能要件

### 6.1 パフォーマンス

- 初期表示 1秒以内
- Lighthouse 90以上
- タスク更新遅延 1秒以内

---

### 6.2 コスト

- Vercel無料枠
- Supabase無料枠
- GitHub無料枠

月額コスト 0円想定

---

### 6.3 セキュリティ

- Supabase Service Role Keyはサーバー側のみ使用
- 公開APIでは anon keyのみ使用
- privateナレッジはビルド除外

**実装時のセキュリティ要件**:

| 項目 | 対策 |
|------|------|
| site_config（github_repo_url） | SSRF 対策: `https://github.com/{owner}/{repo}` 形式のみ許可、ホストを github.com に限定 |
| site_config | 機密情報（トークン等）は保存しない。環境変数または別テーブルで管理 |
| 管理ルート（/admin/*） | サーバー側で管理者チェック。非管理者は 403 またはリダイレクト |
| slug（articles/scraps） | パストラバーサル対策: 英数字・ハイフン・アンダースコアのみ許可 |
| Markdown 表示 | XSS 対策: サニタイズ済みレンダラー、必要に応じて DOMPurify |

**その他のセキュリティ要件**:

| 項目 | 対策 |
|------|------|
| セキュリティヘッダー | Content-Security-Policy, X-Frame-Options, X-Content-Type-Options: nosniff, Referrer-Policy を設定（vercel.json 等） |
| エラーハンドリング | 本番ではスタックトレース・内部エラーをクライアントに返さない。ログに機密情報を含めない |
| 依存関係 | `npm audit` / `pnpm audit` を定期実行。Dependabot 等で更新 |
| GitHub Webhook（将来） | 再ビルド用 Webhook 導入時は `X-Hub-Signature-256` で署名検証。不一致は拒否 |
| OAuth | Supabase の許可リダイレクト URI のみ使用。state による CSRF 対策は Supabase が実施 |
| 環境変数 | 機密情報は Vercel 環境変数で管理。クライアント公開用（NEXT_PUBLIC_ 等）に機密を含めない |
| レート制限 | 独自 API 追加時は検討。Supabase は標準でレート制限あり |
| プレビュー環境 | Vercel プレビューデプロイで本番 Supabase を参照しない。環境変数で Supabase プロジェクトを切り替える |
| OAuth リダイレクト | Supabase の許可リダイレクト URI を本番・開発で正しく設定。ワイルドカードで緩くしすぎない |
| 入力長制限 | タスクの title/description、site_config の value に長さ上限を設ける（巨大ペイロードによる負荷対策） |
| 環境分離 | 開発・ステージング・本番で Supabase プロジェクトを分ける |
| CI/CD | GitHub Actions 等でテスト・ビルドを自動化。シークレットは GitHub Secrets で管理 |

---

## 7. 将来拡張

- GitHub Webhookによる自動再ビルド
- タスクヒートマップ表示（GitHub風）
- タグクラウド可視化
- LLMによるナレッジ自動タグ付け
- 知識グラフ構造表示

---

## 8. 設計思想

1. データは性質ごとに保存場所を分離する
2. 状態管理はDB、履歴資産はGit
3. 外部サービスに過度に依存しない
4. 最小構成で最大表現
5. 管理操作はできる限りコード管理で行う

---
