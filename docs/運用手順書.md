# Obsidian Log 運用手順書

開発者向けの構築・運用マニュアル。要件定義書で定義された仕様を、実際に構築・運用するための手順を記載する。

---

## 1. 初回セットアップ

### 1.1 初回管理者登録

`admins` テーブルが空の状態では、誰もタスクの insert/update/delete ができない。最初の管理者は以下の手順で登録する。

1. Supabase Dashboard にログイン
2. 管理画面（または開発中のアプリ）から GitHub OAuth で一度ログインする
3. Supabase Dashboard → Authentication → Users で、自分のユーザーを確認し **User UID** をコピー
4. Supabase Dashboard → SQL Editor で以下を実行

```sql
INSERT INTO admins (user_id, created_at)
VALUES ('コピーしたUUID', NOW());
```

5. 以降、そのユーザーでログインすると管理者としてタスクの CRUD が可能になる

6. 管理画面 → サイト設定 から **GitHub リポジトリ URL** を登録する（初回は空のため必須）

---

### 1.2 管理者の追加・削除

#### 管理者の追加

1. 追加対象者が一度 GitHub OAuth でログインする
2. Supabase Dashboard → Authentication → Users で該当ユーザーの UID を確認
3. SQL Editor で以下を実行

```sql
INSERT INTO admins (user_id, created_at)
VALUES ('対象者のUUID', NOW());
```

#### 管理者の削除

```sql
DELETE FROM admins WHERE user_id = '対象者のUUID';
```

---

## 2. マイグレーション

### 2.1 スキーマ管理

- テーブル定義の変更はマイグレーションファイルで管理する
- Supabase のマイグレーション機能、またはプロジェクト内の SQL ファイルでバージョン管理する

### 2.2 主要テーブルの初期作成

初回構築時に実行する SQL の例。要件定義書のデータ設計に基づく。

```sql
-- tasks テーブル
CREATE TABLE tasks (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text,
  status text NOT NULL CHECK (status IN ('todo', 'doing', 'done')),
  visibility text NOT NULL DEFAULT 'public' CHECK (visibility IN ('public', 'private')),
  started_at timestamptz,
  completed_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT NOW(),
  updated_at timestamptz NOT NULL DEFAULT NOW()
);

-- admins テーブル
CREATE TABLE admins (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT NOW()
);

-- site_config テーブル（サイト設定）
CREATE TABLE site_config (
  key text PRIMARY KEY,
  value text NOT NULL,
  updated_at timestamptz NOT NULL DEFAULT NOW()
);

-- site_config 初期値（空文字。使用時に管理画面から URL を登録）
INSERT INTO site_config (key, value, updated_at)
VALUES ('github_repo_url', '', NOW());

-- RLS を有効化
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE admins ENABLE ROW LEVEL SECURITY;
ALTER TABLE site_config ENABLE ROW LEVEL SECURITY;

-- tasks の RLS ポリシー（要件定義書に準拠）
CREATE POLICY "tasks_select_public" ON tasks
  FOR SELECT USING (visibility = 'public');

CREATE POLICY "tasks_select_admin" ON tasks
  FOR SELECT USING (
    auth.uid() IN (SELECT user_id FROM admins)
  );

CREATE POLICY "tasks_insert_admin" ON tasks
  FOR INSERT WITH CHECK (
    auth.uid() IN (SELECT user_id FROM admins)
  );

CREATE POLICY "tasks_update_admin" ON tasks
  FOR UPDATE USING (
    auth.uid() IN (SELECT user_id FROM admins)
  );

CREATE POLICY "tasks_delete_admin" ON tasks
  FOR DELETE USING (
    auth.uid() IN (SELECT user_id FROM admins)
  );

-- admins の RLS ポリシー
CREATE POLICY "admins_select_self" ON admins
  FOR SELECT USING (auth.uid() = user_id);

-- site_config の RLS ポリシー
CREATE POLICY "site_config_select_all" ON site_config
  FOR SELECT USING (true);

CREATE POLICY "site_config_modify_admin" ON site_config
  FOR ALL USING (
    auth.uid() IN (SELECT user_id FROM admins)
  )
  WITH CHECK (
    auth.uid() IN (SELECT user_id FROM admins)
  );
```

※ admins の insert/update/delete は RLS で制限せず、Service Role または Dashboard 経由でのみ実施する。

---

## 3. セキュリティ実装のポイント

### 3.1 GitHub URL の検証（SSRF 対策）

`github_repo_url` を保存・使用する際、以下を検証する。

- 形式: `https://github.com/{owner}/{repo}` に一致すること
- ホスト: `github.com` のみ許可（サブドメイン含む場合は要検討）
- 検証例（正規表現）: `^https://github\.com/[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+/?$`

### 3.2 slug の検証（パストラバーサル対策）

`/articles/$slug`, `/scraps/$slug` の slug パラメータは以下を満たすこと。

- 許可文字: 英数字、ハイフン、アンダースコア
- 検証例（正規表現）: `^[a-zA-Z0-9_-]+$`
- `..`, `/`, `\` を含む場合は 404 を返す

### 3.3 環境変数・シークレット

- Service Role Key 等はリポジトリにコミットしない
- Vercel の環境変数で管理
- `site_config` に API トークン等の機密情報を保存しない

### 3.4 セキュリティヘッダー

vercel.json 等で以下を設定する。

```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" }
      ]
    }
  ]
}
```

Content-Security-Policy はアプリの仕様に応じて調整する。

### 3.5 エラーハンドリング

- 本番環境ではスタックトレース・内部エラーメッセージをクライアントに返さない
- エラーログにパスワード・トークン・個人情報を含めない

### 3.6 依存関係の監査

```bash
pnpm audit
# または
npm audit
```

Dependabot や Renovate で自動更新を検討する。

### 3.7 GitHub Webhook（将来拡張時）

再ビルド用 Webhook を導入する場合:

- `X-Hub-Signature-256` ヘッダーで署名を検証する
- Webhook シークレットと payload から HMAC-SHA256 を計算し、一致する場合のみ処理
- 不一致のリクエストは 401 で拒否する

### 3.8 プレビュー環境・環境分離

- **Vercel プレビュー**: プレビューデプロイでは本番 Supabase を参照しない。環境変数 `VITE_SUPABASE_URL` 等でプロジェクトを切り替える
- **環境の分離**: 開発・ステージング・本番で Supabase プロジェクトを分ける。本番データを開発で触らない

### 3.9 OAuth リダイレクト URI

Supabase Dashboard → Authentication → URL Configuration で設定。

- 本番: `https://your-domain.com/**` 等、必要なパスのみ許可
- 開発: `http://localhost:3000/**` 等
- ワイルドカードを過度に緩くしない（例: `https://*.vercel.app` は必要に応じて）

### 3.10 入力長制限

| 項目 | 推奨上限（目安） |
|------|------------------|
| tasks.title | 200 文字 |
| tasks.description | 2000 文字 |
| site_config.value | 500 文字 |

DB の CHECK 制約またはアプリ側のバリデーションで実施。

### 3.11 CI/CD

- GitHub Actions で `pnpm install` → `pnpm run build` を実行
- シークレット（Supabase URL, anon key 等）は GitHub Secrets で管理
- 本番デプロイは main ブランチへの push またはマージ時のみ

---

## 4. バックアップ

- Supabase の無料枠では自動バックアップの期間が限られる
- 重要なデータは定期的にエクスポートすることを推奨
- Supabase Dashboard → Database → Backups で確認

---

## 5. 関連ドキュメント

- [要件定義書](./要件定義書.md)
